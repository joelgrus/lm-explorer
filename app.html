<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>LM Explorer (alpha)</title>
    <style>
    </style>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt"
        crossorigin="anonymous">
</head>

<body>
    <div id="app"></div>

    <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/immutable/3.8.2/immutable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.js"></script>
    <script src="https://unpkg.com/styled-components/dist/styled-components.min.js"></script>
    <script type="text/babel">

        const Wrapper = styled.div`
            font-family: 'Source Sans Pro', sans-serif;
            color: #232323;
        `

        const Title = styled.h1`
            font-size: 1.5em;
            text-align: right;
            color: #2085bc;
            background: url('static/ai2-logo-header.png');
            background-repeat: no-repeat;
            background-size: 360px 71px;
            height: 71px;
            line-height: 71px;
            padding: 5px;
        `

        const Intro = styled.div`
           flex: 1 1 50%;
           position: relative;
           border: 1px solid #efefef;
        `

        const IntroParagraph = styled.p`
            padding: 10px 10px 10px;
        `

        const InputOutput = styled.div`
            display: flex;
        `

        const Inputs = styled.div`
            padding: 10px;
        `

        const TextInput = styled.input`
        `

        const Button = styled.button`
            color: #fff!important;
            background: #2085bc;
        `

        const ChoiceList = styled.ul`
        `

        const ChoiceItem = styled.li`
            cursor: pointer;
            display: table;
        `

        const Probability = styled.span`
            color: gray;
            width: 50px;
            text-align: right;
            float: left;
            margin-right: 5px;
        `

        const Token = styled.span`
        `

        const OutputSentence = styled.div`
            margin: 20px;
            font-family: monospace;
            flex: 1;
        `

        const OutputToken = styled.span`
            cursor: pointer;

        `

        const VR = styled.div`
            border-left: 1px solid lightgray;
            margin: 10px;
            height: 200px;
        `



        const OutputSpace = styled.span`
        `

        const Footer = styled.div`
            position: absolute;
            right: 0;
            bottom: 0;
            left: 0;
            border: 1px solid #efefef;
            padding: 10px 10px 10px;
        `


        class App extends React.Component {

            constructor(props) {
                super(props)

                this.state = {
                    output: "Joel is",
                    words: null,
                    logits: null,
                    probabilities: null
                }

                this.choose = this.choose.bind(this)
                this.setOutput = this.setOutput.bind(this)
                this.runOnEnter = this.runOnEnter.bind(this)
                this.predict = this.predict.bind(this)
            }

            setOutput(evt) {
                const value = evt.target.value
                this.setState({
                    output: value,
                    words: null,
                    logits: null,
                    probabilities: null
                })
            }

            predict(start) {
                const payload = {
                    "previous": start
                }

                const endpoint = '/predict'


                fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => this.setState(data))
            }

            choose(choice = undefined) {
                const payload = {
                    "previous": this.state.output,
                    "next": choice,
                    "numsteps": 5
                    // "numsteps": 3
                }

                const endpoint = '/predict'
                // const endpoint = '/beam'
                //const endpoint = '/random'

                fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => this.setState(data))
            }

            runOnEnter(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    this.choose()
                }
            }

            render() {
                return (
                    <Wrapper>
                        <Title>GPT-2 Explorer</Title>

                        <Intro>
                            <IntroParagraph>
                                This is a demonstration of using the <a href="https://github.com/openai/gpt-2">OpenAI GPT-2</a> language model
                                to generate text. Enter some initial text and click "predict" to generate the most likely next words.
                                Click on one of those words to choose it and continue. Click anywhere in the generated text to "roll back"
                                to that point.
                            </IntroParagraph>
                        </Intro>

                        <InputOutput>
                            <Inputs>
                                <TextInput type="text"
                                        value={this.state.output}
                                        onChange={this.setOutput}
                                        onKeyDown={this.state.output ? this.runOnEnter : null}/>

                                <Button onClick={() => this.choose()}>predict</Button>

                                <Choices choose={this.choose} logits={this.state.logits} words={this.state.words} probabilities={this.state.probabilities}/>
                            </Inputs>

                            <VR/>

                            <Output text={this.state.output} predict={this.predict}/>
                        </InputOutput>

                        <Footer>
                            Built at the <a href="https://allenai.org">Allen Institute for Artificial Intelligence</a> using Hugging Face's <a href="https://github.com/huggingface/pytorch-pretrained-BERT">pytorch-pretrained-BERT</a> library.
                        </Footer>
                    </Wrapper>
                )
            }
        }

        const Output = ({text, predict}) => {
            const tokens = text.split(" ")
            const words = []
            let prefix = ""

            const click = start => () => predict(start)

            tokens.forEach((token, idx) => {
                prefix += token
                words.push(
                    <OutputToken onClick={click(prefix)} key={`${idx}-${token}`}>{token}</OutputToken>)
                prefix += " "
                words.push(<OutputSpace key={`${idx}-whitespace`}>{' '}</OutputSpace>)
            })

            return (
                <OutputSentence>
                    {words}
                </OutputSentence>
            )
        }

        const formatProbability = prob => {
            prob = prob * 100
            return `${prob.toFixed(1)}%`
        }

        const Choices = ({logits, words, choose, probabilities}) => {
            if (!words) { return null }

            const lis = words.map((word, idx) => {
                const logit = logits[idx]
                const prob = formatProbability(probabilities[idx])

                // get rid of CRs
                word = word.replace(/\n/g, "â†µ")

                return (
                    <ChoiceItem class="choice" key={`${idx}-${word}`} onClick={() => choose(word)}>
                        <Probability>{prob}</Probability>
                        {' '}
                        <Token>{word}</Token>
                    </ChoiceItem>
                )
            })

            return (
                <ChoiceList>
                    {lis}
                </ChoiceList>
            )
        }



        ReactDOM.render(<App />, document.getElementById("app"))
    </script>
</body>
</html>
